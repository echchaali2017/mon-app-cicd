name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mon-app-cicd
  K8S_NAMESPACE: default

jobs:
  # JOB 1 : QUALITÃ‰ ET SÃ‰CURITÃ‰
  quality-and-security:
    name: Quality and Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests with Coverage
        run: npx jest --coverage

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

      - name: Run Security Audit
        run: npm audit --audit-level=high

      - name: Run Linter
        run: npx eslint . --ext .js || echo "ESLint non configurÃ©"

  # JOB 2 : TESTS D'INTÃ‰GRATION DOCKER
  docker-integration-tests:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    needs: quality-and-security
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Test Image
        run: docker build -t mon-app-test .

      - name: Run Container Tests
        run: |
          docker run -d --name test-container -p 3002:3000 mon-app-test
          sleep 10  # Wait for app to start
          
          # Test health endpoint
          curl -f http://localhost:3002/health
          
          # Test main endpoint
          response=$(curl -s http://localhost:3002/)
          echo $response | grep -q "Bonjour" && echo "âœ… Main endpoint OK"
          
          # Cleanup
          docker stop test-container
          docker rm test-container

  # JOB 3 : BUILD ET PUSH
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: docker-integration-tests
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=commit-

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # JOB 4 : DÃ‰PLOIEMENT ET TESTS SMOKE
  deploy-and-smoke-test:
    name: Deploy and Smoke Test
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Kubernetes
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure Kubernetes
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > ~/.kube/config

      - name: Deploy Application
        run: |
          kubectl set image deployment/mon-app-deployment \
            mon-app=${{ env.IMAGE_NAME }}:commit-${{ github.sha }} \
            --record -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for Deployment
        run: |
          kubectl rollout status deployment/mon-app-deployment \
            -n ${{ env.K8S_NAMESPACE }} --timeout=300s

      - name: Run Smoke Tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          
          # Get service URL
          SERVICE_URL=$(minikube service mon-app-service --url -n ${{ env.K8S_NAMESPACE }})
          echo "Testing service at: $SERVICE_URL"
          
          # Test 1: Health endpoint
          echo "ðŸ“Š Testing health endpoint..."
          curl -f -s $SERVICE_URL/health | jq '.'
          
          # Test 2: Main endpoint
          echo "ðŸš€ Testing main endpoint..."
          response=$(curl -s $SERVICE_URL/)
          echo $response | jq '.'
          echo $response | grep -q "Bonjour" && echo "âœ… Main endpoint OK"
          
          # Test 3: Verify multiple pods are responding
          echo "ðŸ” Testing load balancing..."
          for i in {1..3}; do
            hostname=$(curl -s $SERVICE_URL/ | jq -r '.hostname')
            echo "Request $i -> Pod: $hostname"
          done
          
          echo "ðŸŽ‰ All smoke tests passed!"
